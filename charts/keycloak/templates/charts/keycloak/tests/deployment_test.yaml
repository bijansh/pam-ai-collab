suite: Test Keycloak Deployment
templates:
  - templates/deployment.yaml

tests:
  - it: should set correct container port
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 8080

  - it: should set Keycloak admin username from values
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[?(@.name=="KEYCLOAK_ADMIN")].value
          value: "admin"

  - it: should create a PVC when persistence is enabled
    set:
      persistence.enabled: true
    asserts:
      - equal:
          path: spec.template.spec.volumes[0].persistentVolumeClaim.claimName
          value: keycloak-pvc

  - it: should mount the PVC to /opt/keycloak/data
    set:
      persistence.enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].mountPath
          value: /opt/keycloak/data

  - it: should configure readiness and liveness probes
    asserts:
      - exists:
          path: spec.template.spec.containers[0].readinessProbe
      - exists:
          path: spec.template.spec.containers[0].livenessProbe

  - it: should set PostgreSQL environment variables
    set:
      postgresql.enabled: true
      postgresql.user: myuser
      postgresql.password: mypass
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[?(@.name=="KC_DB_USERNAME")].value
          value: "myuser"
      - equal:
          path: spec.template.spec.containers[0].env[?(@.name=="KC_DB_PASSWORD")].value
          value: "mypass"
